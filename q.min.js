// vim:ts=4:sts=4:sw=4:
/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 * Forked at 8ff517e193185b100feb881185957a7f211b4c72: 2011-10-13
 *
 * Copyright 2011 Chris Joel under the terms of the MIT license found at
 * http://github.com/cdata/q/raw/master/LICENSE
 */var makeQ=function(a){function c(a){return a}function l(){var b=[],c,d=f(l.prototype),g=f(m.prototype);g.promiseSend=function(){var d=j.call(arguments);b?b.push(d):a(function(){c.promiseSend.apply(c,d)})},g.valueOf=function(){return b?g:c.valueOf()};var i=function(d){var e,f,g;if(!b)return;return c=t(d),h.call(b,function(b,d){a(function(){c.promiseSend.apply(c,d)})},void 0),b=void 0,c};return d.promise=e(g),d.resolve=i,d.reject=function(a){return i(r(a))},d}function m(a,b,d){b===void 0&&(b=function(a){return r("Promise does not support operation: "+a)});var g=f(m.prototype);return g.promiseSend=function(d,e){var f=j.call(arguments,2),g;try{a[d]?g=a[d].apply(a,f):g=b.apply(a,[d].concat(f))}catch(h){g=r(h)}return(e||c)(g)},d&&(g.valueOf=d),e(g)}function n(a){return a&&typeof a.promiseSend=="function"}function o(a){return!n(k(a))}function p(a){return!n(k(a))&&!q(a)}function q(a){return a=k(a),a===void 0||a===null?!1:!!a.promiseRejected}function r(a){var b={};return b.when=function(b){return b?b(a):r(a)},m(b,function(b){return r(a)},function(){var b=f(r.prototype);return b.promiseRejected=!0,b.reason=a,b})}function t(a){if(n(a))return a;if(a&&typeof a.then=="function"){var b=l();return a.then(b.resolve,b.reject),b.promise}var c={};return c.when=function(b){return a},c.get=function(b){return a[b]},c.put=function(b,c){return a[b]=c},c.del=function(b){return delete a[b]},c.post=function(b,c){return a[b].apply(a,c)},c.apply=function(b,c){return a.apply(b,c)},c.viewInfo=function(){var b=a,c={},d={};while(b)Object.getOwnPropertyNames(b).forEach(function(a){c[a]||(c[a]=typeof b[a])}),b=Object.getPrototypeOf(b);return d.type=typeof a,d.properties=c,d},c.keys=function(){return g(a)},m(c,void 0,function(){return a})}function u(a,b){a=t(a);if(b){var c={};return c.viewInfo=function(){return b},m(c,function(b){var c=j.call(arguments);return z.apply(void 0,[a].concat(c))},function(){return k(a)})}return z(a,"viewInfo")}function v(b,c,d){function g(a){try{return c?c(a):a}catch(b){return r(b)}}function h(a){try{return d?d(a):r(a)}catch(b){return r(b)}}var e=l(),f=!1;return a(function(){t(b).promiseSend("when",function(a){if(f)return;f=!0,e.resolve(t(a).promiseSend("when",g,h))},function(a){if(f)return;f=!0,e.resolve(h(a))})}),e.promise}function w(a,b,c){return v(a,function(a){return b.apply(void 0,a)},c)}function x(a){return function(){var b=function(a,b){var f;try{f=c[a](b)}catch(g){return i(g)?g.value:r(g)}return v(f,d,e)},c=a.apply(this,arguments),d=b.bind(b,"send"),e=b.bind(b,"throw");return d()}}function y(a){return function(b){var c=j.call(arguments,1);return z.apply(void 0,[b,a].concat(c))}}function z(b,c){var d=l(),e=j.call(arguments,2);return b=t(b),a(function(){b.promiseSend.apply(b,[c,d.resolve].concat(e))}),d.promise}function D(a){return v(a,function(a){var b=a.length;if(b===0)return t(values);var c=l();return h.call(a,function(d,e,f){v(e,function(d){a[f]=d,--b===0&&c.resolve(a)}).fail(c.reject)},void 0),c.promise})}function E(a,b){return v(a,void 0,b)}function F(a,b){return v(a,function(a){return v(b(),function(){return a})},function(a){return v(b(),function(){return r(a)})})}function G(b){v(b,void 0,function(b){a(function(){throw b})})}function H(a,b){var c=l();return v(a,c.resolve,c.reject),setTimeout(function(){c.reject("Timed out")},b),c.promise}function I(a,b){arguments.length<2&&(b=a,a=void 0);var c=l();return setTimeout(function(){c.resolve(a)},b),c.promise}function J(a){return function(){var b=l(),c=j.call(arguments);return C(a,this,b).fail(b.reject),b.promise}}function K(a){var b=j.call(arguments,1);return J(a).apply(void 0,b)}function L(a){if(arguments.length>1){var b=Array.prototype.slice.call(arguments,1);a=a.bind.apply(a,b)}return function(){var b=l(),c=j.call(arguments);return c.push(b.node()),B(a,this,c).fail(b.reject),b.promise}}function M(a,b){var c=j.call(arguments,2);return L(a).apply(b,c)}"use strict";var b={},d=function(a,b,c){return a[b]||(a[b]=c),a[b]},e=d(Object,"freeze",c),f=d(Object,"create",function(a){var b=function(){};return b.prototype=a,new b}),g=d(Object,"keys",function(a){var b=[];for(var c in a)b.push(c);return b}),h=Array.prototype.reduce||function(a,b){var c=0,d=this.length;if(arguments.length==1)do{if(c in this){b=this[c++];break}if(++c>=d)throw new TypeError}while(1);for(;c<d;c++)c in this&&(b=a(b,this[c],c));return b},i=function(a){return Object.prototype.toString.call(a)==="[object StopIteration]"},j=Array.prototype.slice,k=function(a){return a===void 0||a===null?a:a.valueOf()};b.nextTick=a,b.defer=l,l.prototype.node=function(){var a=this;return function(b,c){b?a.reject(b):arguments.length>2?a.resolve(Array.prototype.slice.call(arguments,1)):a.resolve(c)}},b.makePromise=m,m.prototype.then=function(a,b){return v(this,a,b)},h.call(["when","spread","send","get","put","del","post","invoke","keys","apply","call","all","wait","join","fail","fin","view","viewInfo","timeout","delay","end"],function(a,c){m.prototype[c]=function(){return b[c].apply(b,[this].concat(j.call(arguments)))}},void 0),m.prototype.toSource=function(){return this.toString()},m.prototype.toString=function(){return"[object Promise]"},e(m.prototype),b.isPromise=n,b.isResolved=o,b.isFulfilled=p,b.isRejected=q,b.reject=r;var s={};s.constructor={},s.constructor.value=r,r.prototype=f(m.prototype,s),b.ref=t,b.master=function(a){var b={};return b.isDef=function(){},m(b,function c(b){var c=j.call(arguments);return z.apply(void 0,[a].concat(c))},function(){return k(a)})},b.viewInfo=u,b.view=function(a){return u(a).when(function(b){var c;b.type==="function"?c=function(){return B(a,void 0,arguments)}:c={};var d=b.properties||{};return Object.keys(d).forEach(function(b){d[b]==="function"&&(c[b]=function(){return A(a,b,arguments)})}),t(c)})},b.when=v,b.spread=w,b.async=x,b.Method=y,b.send=z,b.get=y("get"),b.put=y("put"),b.del=y("del");var A=b.post=y("post");b.invoke=function(a,b){var c=j.call(arguments,2);return A(a,b,c)};var B=b.apply=y("apply"),C=b.call=function(a,b){var c=j.call(arguments,2);return B(a,b,c)};return b.keys=y("keys"),b.all=D,b.wait=function(a){return D(arguments).get(0)},b.join=function(){var a=j.call(arguments),b=a.pop();return D(a).spread(b)},b.fail=E,b.fin=F,b.end=G,b.timeout=H,b.delay=I,b.wrap=J,b.wcall=K,b.node=L,b.ncall=M,b};